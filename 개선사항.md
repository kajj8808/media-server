# 미디어 서버 개선 계획 (2025-06 버전)

## 개요
- 현재 프로젝트를 새로운 버전으로 업그레이드
- 2025-06 브랜치를 master로 사용 예정

## 주요 개선 사항 (1차)

### 1. 비디오 파일 스토리지 분리
- **목표**: WSL 환경에서 비디오 파일을 C드라이브/D드라이브로 분리
- **현재 상태**: 확인 필요
- **예상 작업**:
  - 드라이브별 파일 저장 경로 설정
  - 파일 관리 로직 수정
  - 경로 매핑 시스템 구현

### 2. 스트리밍 코드 마이그레이션
- **목표**: 현재 스트리밍 코드를 Hono로 마이그레이션
- **현재 상태**: 기존 프레임워크 확인 필요
- **예상 작업**:
  - Hono 프레임워크 도입
  - 기존 스트리밍 엔드포인트 마이그레이션
  - 성능 최적화 적용

## 작업 순서

### Phase 1: 현재 상태 분석 ✅ 완료
1. [x] 기존 비디오 파일 저장 구조 분석
   - 현재: `public/video/` 경로 사용
   - Express Router 기반 스트리밍
   - Range requests 지원
2. [x] 현재 스트리밍 코드 구조 파악
   - Express + fluent-ffmpeg 사용
   - HEVC/FLAC 코덱 분석 및 변환 로직 포함
   - fs.createReadStream으로 스트리밍
3. [x] 의존성 및 패키지 확인
   - Express 기반, tsx 런타임 사용
   - 배포 환경과 개발 환경 분리 (video 파일 없음)

### Phase 2: 비디오 파일 스토리지 개선
1. [🔄] WSL 드라이브 매핑 구조 설계
   - WSL 환경: /mnt/c, /mnt/d, /mnt/e, /mnt/f 마운트됨
   - **설계 제안**:
     - C드라이브: `/mnt/c/media/videos/` - 자주 접근하는 비디오
     - D드라이브: `/mnt/d/media/videos/` - 아카이브/백업 비디오
     - 환경변수 또는 config로 드라이브 우선순위 설정
     - 용량 기반 자동 분산 로직
2. [ ] 파일 저장/조회 로직 리팩토링
   - 다중 드라이브 경로 검색 함수
   - 파일 이동/복제 관리 시스템
   - 용량 모니터링 및 자동 분산
3. [ ] 테스트 및 검증

### Phase 3: Hono 마이그레이션
1. [🔄] Hono 설치 및 기본 설정
   - **현재**: Express + tsx 런타임
   - **마이그레이션 계획**:
     - Hono 설치 (Bun/Node.js 호환)
     - 기존 Express 미들웨어 → Hono 미들웨어 변환
     - CORS, Helmet, Auth 미들웨어 적용
     - Socket.io 통합 (Hono와 함께 사용)
2. [ ] 스트리밍 엔드포인트 마이그레이션
   - `/media/video/:id` → Hono router로 변환
   - Range requests 처리 로직 유지
   - 성능 최적화 (스트림 처리)
   - 에러 핸들링 개선
3. [ ] 성능 테스트 및 최적화
   - Express vs Hono 벤치마크
   - 메모리 사용량 비교
   - 동시 스트리밍 테스트

### Phase 4: 통합 테스트 및 배포
1. [ ] 전체 시스템 통합 테스트
2. [ ] 성능 벤치마크
3. [ ] 배포 및 모니터링

## 다음 단계 실행 순서

### 즉시 실행 가능한 작업
1. **WSL 드라이브 구조 구현**: 환경 설정 파일 생성 및 경로 매핑 로직
2. **Hono 설치**: 기본 설정 및 Express와 병행 테스트
3. **스트리밍 엔드포인트 변환**: 단계별 마이그레이션

### 주요 고려사항
- 배포 환경과 동일한 WSL C/D 드라이브 구조 활용
- 기존 기능 유지하면서 점진적 개선
- 각 단계별로 충분한 테스트 필요
- tsx 런타임 호환성 확인

### 성공 지표
- [ ] C/D 드라이브 자동 분산 작동
- [ ] Hono 스트리밍 성능 개선 확인
- [ ] 기존 API 호환성 유지
- [ ] 배포 환경에서 정상 작동